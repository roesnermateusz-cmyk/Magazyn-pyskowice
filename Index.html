<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#10b981">
    <meta name="description" content="ResInvest Commodities - System Magazynowy">
    <title>ResInvest Commodities - Magazyn Zrƒôbki</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlJlc0ludmVzdCBDb21tb2RpdGllcyAtIE1hZ2F6eW4gWnLEmWJraSIsCiAgInNob3J0X25hbWUiOiAiTWFnYXp5biBQeXNrb3dpY2UiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiMxMGI5ODEiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgd2lkdGg9JzE5MicgaGVpZ2h0PScxOTInJTNFJTNDcmVjdCB3aWR0aD0nMTkyJyBoZWlnaHQ9JzE5MicgZmlsbD0nJTIzMTBiOTgxJy8lM0UlM0N0ZXh0IHg9JzUwJTI1JyB5PSc1MCUyNScgZm9udC1zaXplPSc5MCcgZmlsbD0nd2hpdGUnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGRvbWluYW50LWJhc2VsaW5lPSdjZW50cmFsJyUzRVJJJTNDL3RleHQlM0UlM0Mvc3ZnJTNFIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgd2lkdGg9JzUxMicgaGVpZ2h0PSc1MTInJTNFJTNDcmVjdCB3aWR0aD0nNTEyJyBoZWlnaHQ9JzUxMicgZmlsbD0nJTIzMTBiOTgxJy8lM0UlM0N0ZXh0IHg9JzUwJTI1JyB5PSc1MCUyNScgZm9udC1zaXplPScyNDAnIGZpbGw9J3doaXRlJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBkb21pbmFudC1iYXNlbGluZT0nY2VudHJhbCclM0VSSiUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0=">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 16px;
            color: #000000;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 24px;
            margin-bottom: 24px;
            text-align: center;
            border: 2px solid #10b981;
        }
        
        .company-name {
            font-size: 32px;
            font-weight: bold;
            color: #000000;
            margin-bottom: 8px;
        }
        
        .system-name {
            font-size: 16px;
            color: #374151;
            font-weight: 500;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #e5e7eb;
        }
        
        h2 {
            color: #000000;
            font-size: 20px;
            margin-bottom: 16px;
            font-weight: 600;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            padding: 20px;
            border-radius: 12px;
            color: #000000;
            border: 2px solid;
        }
        
        .stat-card.green {
            background: #d1fae5;
            border-color: #10b981;
        }
        
        .stat-card.blue {
            background: #dbeafe;
            border-color: #3b82f6;
        }
        
        .stat-card.orange {
            background: #fed7aa;
            border-color: #f97316;
        }
        
        .stat-label {
            font-size: 14px;
            color: #374151;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #000000;
            margin-bottom: 4px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        
        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #000000;
            margin-bottom: 8px;
        }
        
        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            color: #000000;
            background: #ffffff;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #000000;
        }
        
        .btn-primary {
            background: #10b981;
            color: #ffffff;
            flex: 1;
        }
        
        .btn-primary:hover {
            background: #059669;
        }
        
        .btn-secondary {
            background: #3b82f6;
            color: #ffffff;
        }
        
        .btn-secondary:hover {
            background: #2563eb;
        }
        
        .btn-purple {
            background: #a78bfa;
            color: #000000;
        }
        
        .btn-purple:hover {
            background: #8b5cf6;
        }
        
        .btn-gray {
            background: #e5e7eb;
            color: #000000;
        }
        
        .btn-gray:hover {
            background: #d1d5db;
        }
        
        .btn-warning {
            background: #fbbf24;
            color: #000000;
        }
        
        .btn-warning:hover {
            background: #f59e0b;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #e5e7eb;
            color: #000000;
        }
        
        th {
            background: #f3f4f6;
            font-weight: 600;
            font-size: 14px;
        }
        
        td {
            font-size: 14px;
        }
        
        tr:hover {
            background: #f9fafb;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            border: 2px solid;
        }
        
        .badge-pz {
            background: #dbeafe;
            color: #000000;
            border-color: #3b82f6;
        }
        
        .badge-wz {
            background: #fed7aa;
            color: #000000;
            border-color: #f97316;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 16px;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid #10b981;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #000000;
            padding: 0;
            width: 32px;
            height: 32px;
        }
        
        .vehicle-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .vehicle-name {
            flex: 1;
            font-weight: 600;
            color: #000000;
        }
        
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            color: #000000;
            font-size: 18px;
        }
        
        .icon-btn:hover {
            opacity: 0.7;
        }
        
        .calc-result {
            background: #dbeafe;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            border: 2px solid #3b82f6;
        }
        
        .calc-result-label {
            font-size: 14px;
            color: #000000;
            margin-bottom: 4px;
            font-weight: 600;
        }
        
        .calc-result-value {
            font-size: 32px;
            font-weight: bold;
            color: #000000;
        }
        
        .backup-section {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .company-name {
                font-size: 24px;
            }
            
            .system-name {
                font-size: 14px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-value {
                font-size: 28px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .backup-section {
                flex-direction: column;
            }
        }
        
        .install-prompt {
            background: #10b981;
            color: #ffffff;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: none;
        }
        
        .install-prompt.show {
            display: block;
        }
        
        .install-prompt button {
            margin-top: 12px;
            background: white;
            color: #10b981;
        }
        
        .install-prompt h3 {
            color: #ffffff;
            margin-bottom: 8px;
        }
        
        .install-prompt p {
            color: #ffffff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="install-prompt" id="installPrompt">
            <h3>üì± Zainstaluj aplikacjƒô</h3>
            <p>Dodaj aplikacjƒô do ekranu g≈Ç√≥wnego telefonu dla szybszego dostƒôpu!</p>
            <button onclick="installApp()">Zainstaluj teraz</button>
            <button class="btn-gray" onclick="closeInstallPrompt()">Mo≈ºe p√≥≈∫niej</button>
        </div>

        <div class="header">
            <div class="company-name">ResInvest Commodities</div>
            <div class="system-name">System magazynowy zrƒôbki drzewnej - magazyn Pyskowice</div>
        </div>

        <div class="stats-grid">
            <div class="stat-card green">
                <div class="stat-label">Aktualny Stan</div>
                <div class="stat-value" id="currentStock">0.00</div>
                <div class="stat-label">metr√≥w przestrzennych</div>
            </div>
            <div class="stat-card blue">
                <div class="stat-label">PZ w tym miesiƒÖcu</div>
                <div class="stat-value" id="monthlyPZ">0.00</div>
                <div class="stat-label">mp</div>
            </div>
            <div class="stat-card orange">
                <div class="stat-label">WZ w tym miesiƒÖcu</div>
                <div class="stat-value" id="monthlyWZ">0.00</div>
                <div class="stat-label">mp</div>
            </div>
        </div>

        <div class="card">
            <h2>Dodaj Operacjƒô</h2>
            <div class="form-grid">
                <div>
                    <label>Data</label>
                    <input type="date" id="opDate">
                </div>
                <div>
                    <label>Typ</label>
                    <select id="opType" onchange="updateNumber()">
                        <option value="PZ">PZ (Przyjƒôcie)</option>
                        <option value="WZ">WZ (Wydanie)</option>
                    </select>
                </div>
                <div>
                    <label>Pojazd</label>
                    <select id="opVehicle" onchange="handleVehicleSelect()">
                        <option value="">Wybierz pojazd</option>
                    </select>
                </div>
                <div>
                    <label>Nr bie≈ºƒÖcy</label>
                    <input type="number" id="opNumber" readonly>
                </div>
                <div>
                    <label>Objƒôto≈õƒá (mp)</label>
                    <input type="number" step="0.01" id="opVolume">
                </div>
            </div>
            <div class="btn-group">
                <button class="btn-primary" onclick="addOperation()">Dodaj Operacjƒô</button>
                <button class="btn-secondary" onclick="openCalculator()">üî¢ Kalkulator</button>
                <button class="btn-purple" onclick="openReportDialog()">üìÑ Raport</button>
            </div>
        </div>

        <div class="card">
            <h2>ZarzƒÖdzanie Danymi</h2>
            <div class="backup-section">
                <button class="btn-secondary" onclick="exportToExcel()">üìä Eksport do Excel</button>
                <button class="btn-secondary" onclick="exportToCSV()">üìÑ Eksport do CSV</button>
                <button class="btn-warning" onclick="backupData()">üíæ Kopia Zapasowa</button>
                <button class="btn-primary" onclick="document.getElementById('restoreFile').click()">üì• Przywr√≥ƒá Dane</button>
                <input type="file" id="restoreFile" accept=".json" style="display: none;" onchange="restoreData(event)">
            </div>
        </div>

        <div class="card">
            <h2>Raport na Pojazd</h2>
            <div style="overflow-x: auto;">
                <table id="vehicleReport">
                    <thead>
                        <tr>
                            <th>Pojazd</th>
                            <th style="text-align: right;">PZ (mp)</th>
                            <th style="text-align: right;">WZ (mp)</th>
                            <th style="text-align: right;">Bilans (mp)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h2>Historia Operacji</h2>
            <div style="overflow-x: auto;">
                <table id="operationsTable">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Typ</th>
                            <th>Pojazd</th>
                            <th style="text-align: right;">Nr</th>
                            <th style="text-align: right;">Objƒôto≈õƒá (mp)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Kalkulatora -->
    <div class="modal" id="calculatorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üî¢ Kalkulator Objƒôto≈õci Zrƒôbki</h2>
                <button class="close-btn" onclick="closeCalculator()">√ó</button>
            </div>
            <div>
                <label>Pojazd</label>
                <select id="calcVehicle">
                    <option value="">Wybierz pojazd</option>
                </select>
            </div>
            <div style="margin-top: 16px;">
                <label>D≈Çugo≈õƒá (m)</label>
                <input type="number" step="0.01" id="calcLength" oninput="calculateVolume()">
            </div>
            <div style="margin-top: 16px;">
                <label>Szeroko≈õƒá (m)</label>
                <input type="number" step="0.01" id="calcWidth" oninput="calculateVolume()">
            </div>
            <div style="margin-top: 16px;">
                <label>Wysoko≈õƒá (m)</label>
                <input type="number" step="0.01" id="calcHeight" oninput="calculateVolume()">
            </div>
            <div class="calc-result" id="calcResult" style="display: none;">
                <div class="calc-result-label">Obliczona objƒôto≈õƒá:</div>
                <div class="calc-result-value" id="calcResultValue">0.00 mp</div>
            </div>
            <div class="btn-group" style="margin-top: 24px;">
                <button class="btn-secondary" onclick="applyCalculation()">Zatwierd≈∫</button>
                <button class="btn-gray" onclick="closeCalculator()">Anuluj</button>
            </div>
        </div>
    </div>

    <!-- Modal ZarzƒÖdzania Pojazdami -->
    <div class="modal" id="vehicleManagerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è ZarzƒÖdzaj Pojazdami</h2>
                <button class="close-btn" onclick="closeVehicleManager()">√ó</button>
            </div>
            <div id="vehicleList"></div>
            <button class="btn-primary" style="margin-top: 16px; width: 100%;" onclick="openAddVehicle()">+ Dodaj Nowy Pojazd</button>
        </div>
    </div>

    <!-- Modal Dodawania Pojazdu -->
    <div class="modal" id="addVehicleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Dodaj Nowy Pojazd</h2>
                <button class="close-btn" onclick="closeAddVehicle()">√ó</button>
            </div>
            <div>
                <label>Nr rejestracyjny</label>
                <input type="text" id="newVehicle" placeholder="np. SK7H433" style="text-transform: uppercase;">
            </div>
            <div class="btn-group" style="margin-top: 24px;">
                <button class="btn-primary" onclick="addVehicle()">Dodaj</button>
                <button class="btn-gray" onclick="closeAddVehicle()">Anuluj</button>
            </div>
        </div>
    </div>

    <!-- Modal Konfiguracji Raportu -->
    <div class="modal" id="reportConfigModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Konfiguracja Raportu</h2>
                <button class="close-btn" onclick="closeReportDialog()">√ó</button>
            </div>
            <div>
                <label>Okres</label>
                <select id="reportPeriod" onchange="updateReportPeriodFields()">
                    <option value="monthly">Raport Miesiƒôczny</option>
                    <option value="yearly">Raport Roczny</option>
                </select>
            </div>
            <div style="margin-top: 16px;" id="monthField">
                <label>MiesiƒÖc</label>
                <input type="month" id="reportMonth">
            </div>
            <div style="margin-top: 16px; display: none;" id="yearField">
                <label>Rok</label>
                <input type="number" id="reportYear">
            </div>
            <div style="margin-top: 16px;">
                <label>Typ Raportu</label>
                <select id="reportType">
                    <option value="complete">Raport Kompletny (PZ + WZ)</option>
                    <option value="PZ">Raport PZ (Przyjƒôcia)</option>
                    <option value="WZ">Raport WZ (Wydania)</option>
                </select>
            </div>
            <div class="btn-group" style="margin-top: 24px;">
                <button class="btn-purple" onclick="generateReport()">Generuj Raport</button>
                <button class="btn-gray" onclick="closeReportDialog()">Anuluj</button>
            </div>
        </div>
    </div>

    <!-- Modal Raportu -->
    <div class="modal" id="reportModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="reportTitle">Raport</h2>
                <button class="close-btn" onclick="closeReport()">√ó</button>
            </div>
            <div id="reportContent"></div>
            <div class="btn-group" style="margin-top: 24px;">
                <button class="btn-secondary" onclick="window.print()">üñ®Ô∏è Drukuj</button>
                <button class="btn-gray" onclick="closeReport()">Zamknij</button>
            </div>
        </div>
    </div>

    <script>
        let deferredPrompt;
        let operations = [];
        let vehicles = ['SK7H433', 'WA12345', 'GD67890'];
        
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setTodayDate();
            updateVehicleSelects();
            updateDisplay();
            registerServiceWorker();
        });
        
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const swCode = `
                    self.addEventListener('install', (e) => {
                        self.skipWaiting();
                    });
                    self.addEventListener('activate', (e) => {
                        self.clients.claim();
                    });
                `;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl);
            }
        }
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').classList.add('show');
        });
        
        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    deferredPrompt = null;
                    closeInstallPrompt();
                });
            }
        }
        
        function closeInstallPrompt() {
            document.getElementById('installPrompt').classList.remove('show');
        }
        
        function loadData() {
            const savedOps = localStorage.getItem('resinvest_operations');
            const savedVehicles = localStorage.getItem('resinvest_vehicles');
            
            if (savedOps) operations = JSON.parse(savedOps);
            if (savedVehicles) vehicles = JSON.parse(savedVehicles);
        }
        
        function saveData() {
            localStorage.setItem('resinvest_operations', JSON.stringify(operations));
            localStorage.setItem('resinvest_vehicles', JSON.stringify(vehicles));
        }
        
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('opDate').value = today;
            document.getElementById('reportMonth').value = today.slice(0, 7);
            document.getElementById('reportYear').value = new Date().getFullYear();
        }
        
        function updateVehicleSelects() {
            const selects = ['opVehicle', 'calcVehicle'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                const currentValue = select.value;
                select.innerHTML = '<option value="">Wybierz pojazd</option>';
                
                vehicles.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v;
                    opt.textContent = v;
                    select.appendChild(opt);
                });
                
                if (id === 'opVehicle') {
                    const addOpt = document.createElement('option');
                    addOpt.value = 'ADD_NEW';
                    addOpt.textContent = '+ DODAJ POJAZD';
                    select.appendChild(addOpt);
                    
                    const manageOpt = document.createElement('option');
                    manageOpt.value = 'MANAGE';
                    manageOpt.textContent = '‚öô ZARZƒÑDZAJ POJAZDAMI';
                    select.appendChild(manageOpt);
                }
                
                select.value = currentValue;
            });
        }
        
        function handleVehicleSelect() {
            const select = document.getElementById('opVehicle');
            if (select.value === 'ADD_NEW') {
                openAddVehicle();
                select.value = '';
            } else if (select.value === 'MANAGE') {
                openVehicleManager();
                select.value = '';
            } else {
                updateNumber();
            }
        }
        
        function updateNumber() {
            const vehicle = document.getElementById('opVehicle').value;
            const type = document.getElementById('opType').value;
            if (vehicle && vehicle !== 'ADD_NEW' && vehicle !== 'MANAGE') {
                const count = operations.filter(op => op.vehicle === vehicle && op.type === type).length;
                document.getElementById('opNumber').value = count + 1;
            }
        }
        
        function addOperation() {
            const date = document.getElementById('opDate').value;
            const type = document.getElementById('opType').value;
            const vehicle = document.getElementById('opVehicle').value;
            const number = document.getElementById('opNumber').value;
            const volume = parseFloat(document.getElementById('opVolume').value);
            
            if (!vehicle || !volume || vehicle === 'ADD_NEW' || vehicle === 'MANAGE') {
                alert('Wybierz pojazd i wprowad≈∫ objƒôto≈õƒá!');
                return;
            }
            
            operations.push({
                id: Date.now(),
                date,
                type,
                vehicle,
                number: parseInt(number),
                volume
            });
            
            saveData();
            updateDisplay();
            
            document.getElementById('opVolume').value = '';
            updateNumber();
        }
        
        function updateDisplay() {
            updateStats();
            updateVehicleReport();
            updateOperationsTable();
        }
        
        function updateStats() {
            let currentStock = 0;
            let monthlyPZ = 0;
            let monthlyWZ = 0;
            const currentMonth = new Date().toISOString().slice(0, 7);
            
            operations.forEach(op => {
                currentStock += op.type === 'PZ' ? op.volume : -op.volume;
                
                if (op.date.startsWith(currentMonth)) {
                    if (op.type === 'PZ') monthlyPZ += op.volume;
                    else monthlyWZ += op.volume;
                }
            });
            
            document.getElementById('currentStock').textContent = currentStock.toFixed(2);
            document.getElementById('monthlyPZ').textContent = monthlyPZ.toFixed(2);
            document.getElementById('monthlyWZ').textContent = monthlyWZ.toFixed(2);
        }
        
        function updateVehicleReport() {
            const stats = {};
            operations.forEach(op => {
                if (!stats[op.vehicle]) {
                    stats[op.vehicle] = { PZ: 0, WZ: 0, total: 0 };
                }
                stats[op.vehicle][op.type] += op.volume;
                stats[op.vehicle].total += op.type === 'PZ' ? op.volume : -op.volume;
            });
            
            const tbody = document.querySelector('#vehicleReport tbody');
            tbody.innerHTML = '';
            
            Object.entries(stats).forEach(([vehicle, data]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 600;">${vehicle}</td>
                    <td style="text-align: right; color: #10b981; font-weight: 600;">${data.PZ.toFixed(2)}</td>
                    <td style="text-align: right; color: #f97316; font-weight: 600;">${data.WZ.toFixed(2)}</td>
                    <td style="text-align: right; font-weight: 700;">${data.total.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateOperationsTable() {
            const tbody = document.querySelector('#operationsTable tbody');
            tbody.innerHTML = '';
            
            const sorted = [...operations].reverse();
            sorted.forEach(op => {
                const row = document.createElement('tr');
                const date = new Date(op.date).toLocaleDateString('pl-PL');
                row.innerHTML = `
                    <td>${date}</td>
                    <td><span class="badge badge-${op.type.toLowerCase()}">${op.type}</span></td>
                    <td style="font-weight: 600;">${op.vehicle}</td>
                    <td style="text-align: right;">${op.number}</td>
                    <td style="text-align: right; font-weight: 600;">${op.volume.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Eksport do Excel
        function exportToExcel() {
            if (typeof XLSX === 'undefined') {
                alert('Biblioteka Excel nie zosta≈Ça za≈Çadowana. U≈ºyj eksportu CSV.');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // Arkusz operacji
            const opsData = operations.map(op => ({
                'Data': new Date(op.date).toLocaleDateString('pl-PL'),
                'Typ': op.type,
                'Pojazd': op.vehicle,
                'Numer': op.number,
                'Objƒôto≈õƒá (mp)': op.volume
            }));
            const ws1 = XLSX.utils.json_to_sheet(opsData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Operacje');
            
            // Arkusz statystyk pojazd√≥w
            const stats = {};
            operations.forEach(op => {
                if (!stats[op.vehicle]) {
                    stats[op.vehicle] = { PZ: 0, WZ: 0, total: 0 };
                }
                stats[op.vehicle][op.type] += op.volume;
                stats[op.vehicle].total += op.type === 'PZ' ? op.volume : -op.volume;
            });
            
            const vehicleData = Object.entries(stats).map(([vehicle, data]) => ({
                'Pojazd': vehicle,
                'PZ (mp)': data.PZ.toFixed(2),
                'WZ (mp)': data.WZ.toFixed(2),
                'Bilans (mp)': data.total.toFixed(2)
            }));
            const ws2 = XLSX.utils.json_to_sheet(vehicleData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Statystyki Pojazd√≥w');
            
            const fileName = `Magazyn_Pyskowice_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            alert('Dane wyeksportowane do Excel!');
        }
        
        // Eksport do CSV
        function exportToCSV() {
            let csv = 'Data,Typ,Pojazd,Numer,Objƒôto≈õƒá (mp)\n';
            operations.forEach(op => {
                const date = new Date(op.date).toLocaleDateString('pl-PL');
                csv += `${date},${op.type},${op.vehicle},${op.number},${op.volume}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Magazyn_Pyskowice_${new Date().toISOString().split('T')[0]}.csv`);
            link.click();
            alert('Dane wyeksportowane do CSV!');
        }
        
        // Kopia zapasowa
        function backupData() {
            const backup = {
                operations: operations,
                vehicles: vehicles,
                timestamp: new Date().toISOString(),
                location: 'Magazyn Pyskowice'
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Backup_Pyskowice_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            alert('Kopia zapasowa utworzona!');
        }
        
        // Przywracanie danych
        function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (confirm('Czy na pewno chcesz przywr√≥ciƒá dane? Obecne dane zostanƒÖ zastƒÖpione!')) {
                        operations = backup.operations || [];
                        vehicles = backup.vehicles || [];
                        saveData();
                        updateVehicleSelects();
                        updateDisplay();
                        alert('Dane zosta≈Çy przywr√≥cone!');
                    }
                } catch (error) {
                    alert('B≈ÇƒÖd podczas odczytu pliku kopii zapasowej!');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // Kalkulator
        function openCalculator() {
            document.getElementById('calculatorModal').classList.add('active');
            document.getElementById('calcLength').value = '';
            document.getElementById('calcWidth').value = '';
            document.getElementById('calcHeight').value = '';
            document.getElementById('calcVehicle').value = '';
            document.getElementById('calcResult').style.display = 'none';
        }
        
        function closeCalculator() {
            document.getElementById('calculatorModal').classList.remove('active');
        }
        
        function calculateVolume() {
            const length = parseFloat(document.getElementById('calcLength').value);
            const width = parseFloat(document.getElementById('calcWidth').value);
            const height = parseFloat(document.getElementById('calcHeight').value);
            
            if (length && width && height) {
                const volume = (length * width * height).toFixed(2);
                document.getElementById('calcResultValue').textContent = volume + ' mp';
                document.getElementById('calcResult').style.display = 'block';
            } else {
                document.getElementById('calcResult').style.display = 'none';
            }
        }
        
        function applyCalculation() {
            const length = parseFloat(document.getElementById('calcLength').value);
            const width = parseFloat(document.getElementById('calcWidth').value);
            const height = parseFloat(document.getElementById('calcHeight').value);
            const vehicle = document.getElementById('calcVehicle').value;
            
            if (length && width && height && vehicle) {
                const volume = (length * width * height).toFixed(2);
                document.getElementById('opVolume').value = volume;
                document.getElementById('opVehicle').value = vehicle;
                updateNumber();
                closeCalculator();
            } else {
                alert('Wype≈Çnij wszystkie pola!');
            }
        }
        
        // ZarzƒÖdzanie pojazdami
        function openVehicleManager() {
            document.getElementById('vehicleManagerModal').classList.add('active');
            updateVehicleList();
        }
        
        function closeVehicleManager() {
            document.getElementById('vehicleManagerModal').classList.remove('active');
        }
        
        function updateVehicleList() {
            const list = document.getElementById('vehicleList');
            list.innerHTML = '';
            
            vehicles.forEach(vehicle => {
                const item = document.createElement('div');
                item.className = 'vehicle-item';
                item.innerHTML = `
                    <span class="vehicle-name">${vehicle}</span>
                    <button class="icon-btn" onclick="editVehicle('${vehicle}')" title="Edytuj">‚úèÔ∏è</button>
                    <button class="icon-btn" onclick="deleteVehicle('${vehicle}')" title="Usu≈Ñ">üóëÔ∏è</button>
                `;
                list.appendChild(item);
            });
        }
        
        function editVehicle(oldName) {
            const newName = prompt('Podaj nowƒÖ nazwƒô pojazdu:', oldName);
            if (newName && newName.trim()) {
                const upperName = newName.toUpperCase();
                const index = vehicles.indexOf(oldName);
                if (index !== -1) {
                    vehicles[index] = upperName;
                    operations.forEach(op => {
                        if (op.vehicle === oldName) op.vehicle = upperName;
                    });
                    saveData();
                    updateVehicleSelects();
                    updateVehicleList();
                    updateDisplay();
                }
            }
        }
        
        function deleteVehicle(vehicle) {
            if (confirm(`Czy na pewno chcesz usunƒÖƒá pojazd ${vehicle}?`)) {
                vehicles = vehicles.filter(v => v !== vehicle);
                saveData();
                updateVehicleSelects();
                updateVehicleList();
                updateDisplay();
            }
        }
        
        function openAddVehicle() {
            closeVehicleManager();
            document.getElementById('addVehicleModal').classList.add('active');
            document.getElementById('newVehicle').value = '';
        }
        
        function closeAddVehicle() {
            document.getElementById('addVehicleModal').classList.remove('active');
        }
        
        function addVehicle() {
            const input = document.getElementById('newVehicle');
            const vehicle = input.value.trim().toUpperCase();
            
            if (vehicle) {
                if (!vehicles.includes(vehicle)) {
                    vehicles.push(vehicle);
                    saveData();
                    updateVehicleSelects();
                    closeAddVehicle();
                    alert('Pojazd dodany!');
                } else {
                    alert('Taki pojazd ju≈º istnieje!');
                }
            }
        }
        
        // Raporty
        function openReportDialog() {
            document.getElementById('reportConfigModal').classList.add('active');
        }
        
        function closeReportDialog() {
            document.getElementById('reportConfigModal').classList.remove('active');
        }
        
        function updateReportPeriodFields() {
            const period = document.getElementById('reportPeriod').value;
            if (period === 'monthly') {
                document.getElementById('monthField').style.display = 'block';
                document.getElementById('yearField').style.display = 'none';
            } else {
                document.getElementById('monthField').style.display = 'none';
                document.getElementById('yearField').style.display = 'block';
            }
        }
        
        function generateReport() {
            const period = document.getElementById('reportPeriod').value;
            const type = document.getElementById('reportType').value;
            const month = document.getElementById('reportMonth').value;
            const year = document.getElementById('reportYear').value;
            
            let filtered = operations;
            
            if (period === 'monthly') {
                filtered = filtered.filter(op => op.date.startsWith(month));
            } else {
                filtered = filtered.filter(op => op.date.startsWith(year));
            }
            
            if (type !== 'complete') {
                filtered = filtered.filter(op => op.type === type);
            }
            
            const stats = {
                totalPZ: 0,
                totalWZ: 0,
                balance: 0,
                operations: filtered.length,
                byVehicle: {}
            };
            
            filtered.forEach(op => {
                const vol = parseFloat(op.volume);
                if (op.type === 'PZ') {
                    stats.totalPZ += vol;
                    stats.balance += vol;
                } else {
                    stats.totalWZ += vol;
                    stats.balance -= vol;
                }
                
                if (!stats.byVehicle[op.vehicle]) {
                    stats.byVehicle[op.vehicle] = { PZ: 0, WZ: 0, count: 0 };
                }
                stats.byVehicle[op.vehicle][op.type] += vol;
                stats.byVehicle[op.vehicle].count++;
            });
            
            displayReport(period, type, month, year, stats, filtered);
            closeReportDialog();
        }
        
        function displayReport(period, type, month, year, stats, data) {
            const periodText = period === 'monthly' 
                ? new Date(month + '-01').toLocaleDateString('pl-PL', { year: 'numeric', month: 'long' })
                : year;
            
            const typeText = type === 'complete' ? 'Kompletny' : type;
            
            document.getElementById('reportTitle').textContent = 
                `Raport ${period === 'monthly' ? 'Miesiƒôczny' : 'Roczny'} - ${typeText}`;
            
            let html = `<div style="margin-bottom: 16px; color: #374151; font-weight: 600;">Okres: ${periodText}</div>`;
            
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px;">';
            html += `<div style="background: #dbeafe; padding: 16px; border-radius: 8px; border: 2px solid #3b82f6;">
                <div style="font-size: 14px; color: #000000; font-weight: 600;">Liczba operacji</div>
                <div style="font-size: 24px; font-weight: bold; color: #000000;">${stats.operations}</div>
            </div>`;
            
            if (type === 'complete' || type === 'PZ') {
                html += `<div style="background: #d1fae5; padding: 16px; border-radius: 8px; border: 2px solid #10b981;">
                    <div style="font-size: 14px; color: #000000; font-weight: 600;">Suma PZ</div>
                    <div style="font-size: 24px; font-weight: bold; color: #000000;">${stats.totalPZ.toFixed(2)} mp</div>
                </div>`;
            }
            
            if (type === 'complete' || type === 'WZ') {
                html += `<div style="background: #fed7aa; padding: 16px; border-radius: 8px; border: 2px solid #f97316;">
                    <div style="font-size: 14px; color: #000000; font-weight: 600;">Suma WZ</div>
                    <div style="font-size: 24px; font-weight: bold; color: #000000;">${stats.totalWZ.toFixed(2)} mp</div>
                </div>`;
            }
            
            if (type === 'complete') {
                html += `<div style="background: #e9d5ff; padding: 16px; border-radius: 8px; border: 2px solid #a78bfa;">
                    <div style="font-size: 14px; color: #000000; font-weight: 600;">Bilans</div>
                    <div style="font-size: 24px; font-weight: bold; color: #000000;">${stats.balance.toFixed(2)} mp</div>
                </div>`;
            }
            html += '</div>';
            
            html += '<h3 style="margin: 24px 0 16px 0; font-weight: 600;">Zestawienie wed≈Çug pojazd√≥w</h3>';
            html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 24px;">';
            html += '<thead><tr style="background: #f3f4f6;">';
            html += '<th style="padding: 12px; text-align: left; border: 2px solid #e5e7eb;">Pojazd</th>';
            html += '<th style="padding: 12px; text-align: right; border: 2px solid #e5e7eb;">Operacje</th>';
            if (type === 'complete' || type === 'PZ') {
                html += '<th style="padding: 12px; text-align: right; border: 2px solid #e5e7eb;">PZ (mp)</th>';
            }
            if (type === 'complete' || type === 'WZ') {
                html += '<th style="padding: 12px; text-align: right; border: 2px solid #e5e7eb;">WZ (mp)</th>';
            }
            html += '</tr></thead><tbody>';
            
            Object.entries(stats.byVehicle).forEach(([vehicle, vdata]) => {
                html += '<tr>';
                html += `<td style="padding: 12px; border: 2px solid #e5e7eb; font-weight: 600;">${vehicle}</td>`;
                html += `<td style="padding: 12px; text-align: right; border: 2px solid #e5e7eb;">${vdata.count}</td>`;
                if (type === 'complete' || type === 'PZ') {
                    html += `<td style="padding: 12px; text-align: right; border: 2px solid #e5e7eb; color: #10b981; font-weight: 600;">${vdata.PZ.toFixed(2)}</td>`;
                }
                if (type === 'complete' || type === 'WZ') {
                    html += `<td style="padding: 12px; text-align: right; border: 2px solid #e5e7eb; color: #f97316; font-weight: 600;">${vdata.WZ.toFixed(2)}</td>`;
                }
                html += '</tr>';
            });
            html += '</tbody></table>';
            
            html += '<h3 style="margin: 24px 0 16px 0; font-weight: 600;">Szczeg√≥≈Çowa lista operacji</h3>';
            html += '<div style="max-height: 400px; overflow-y: auto;">';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead style="position: sticky; top: 0; background: white;"><tr style="background: #f3f4f6;">';
            html += '<th style="padding: 12px; text-align: left; border: 2px solid #e5e7eb;">Data</th>';
            html += '<th style="padding: 12px; text-align: left; border: 2px solid #e5e7eb;">Typ</th>';
            html += '<th style="padding: 12px; text-align: left; border: 2px solid #e5e7eb;">Pojazd</th>';
            html += '<th style="padding: 12px; text-align: right; border: 2px solid #e5e7eb;">Nr</th>';
            html += '<th style="padding: 12px; text-align: right; border: 2px solid #e5e7eb;">Objƒôto≈õƒá (mp)</th>';
            html += '</tr></thead><tbody>';
            
            data.forEach(op => {
                const date = new Date(op.date).toLocaleDateString('pl-PL');
                html += '<tr>';
                html += `<td style="padding: 12px; border: 2px solid #e5e7eb;">${date}</td>`;
                html += `<td style="padding: 12px; border: 2px solid #e5e7eb;"><span class="badge badge-${op.type.toLowerCase()}">${op.type}</span></td>`;
                html += `<td style="padding: 12px; border: 2px solid #e5e7eb; font-weight: 600;">${op.vehicle}</td>`;
                html += `<td style="padding: 12px; text-align: right; border: 2px solid #e5e7eb;">${op.number}</td>`;
                html += `<td style="padding: 12px; text-align: right; border: 2px solid #e5e7eb; font-weight: 600;">${op.volume.toFixed(2)}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            
            document.getElementById('reportContent').innerHTML = html;
            document.getElementById('reportModal').classList.add('active');
        }
        
        function closeReport() {
            document.getElementById('reportModal').classList.remove('active');
        }
    </script>
</body>
</html>
