const app = {
    operations: [],
    vehicles: ['SK7H433', 'WA12345', 'GD67890'],
    editingOp: null,

    init() {
        this.loadData();
        this.setToday();
        this.updateVehicleSelects();
        this.updateDisplay();
        this.registerSW();
    },

    registerSW() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    },

    loadData() {
        const ops = localStorage.getItem('resinvest_operations');
        const vehs = localStorage.getItem('resinvest_vehicles');
        if (ops) this.operations = JSON.parse(ops);
        if (vehs) this.vehicles = JSON.parse(vehs);
    },

    saveData() {
        localStorage.setItem('resinvest_operations', JSON.stringify(this.operations));
        localStorage.setItem('resinvest_vehicles', JSON.stringify(this.vehicles));
    },

    setToday() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('opDate').value = today;
        document.getElementById('reportMonth').value = today.slice(0, 7);
        document.getElementById('reportYear').value = new Date().getFullYear();
    },

    updateVehicleSelects() {
        const selects = ['opVehicle', 'calcVehicle', 'editVehicle', 'vehicleToDelete'];
        selects.forEach(id => {
            const sel = document.getElementById(id);
            const curr = sel.value;
            sel.innerHTML = '<option value="">Wybierz pojazd</option>';
            this.vehicles.forEach(v => {
                sel.innerHTML += `<option value="${v}">${v}</option>`;
            });
            if (id === 'opVehicle') {
                sel.innerHTML += '<option value="ADD_NEW">+ DODAJ POJAZD</option>';
                sel.innerHTML += '<option value="DELETE">- USU≈É POJAZD</option>';
            }
            sel.value = curr;
        });
    },

    handleVehicleSelect() {
        const val = document.getElementById('opVehicle').value;
        if (val === 'ADD_NEW') {
            this.showModal('addVehicle');
            document.getElementById('opVehicle').value = '';
        } else if (val === 'DELETE') {
            this.showModal('deleteVehicle');
            document.getElementById('opVehicle').value = '';
        }
        this.updateNumber();
    },

    updateNumber() {
        document.getElementById('opNumber').value = this.operations.length + 1;
    },

    updateLabels() {
        const type = document.getElementById('opType').value;
        document.getElementById('contractorLabel').textContent = type === 'PZ' ? 'Dostawca' : 'Odbiorca';
        document.getElementById('operatorLabel').textContent = type === 'PZ' ? 'PrzyjƒÖ≈Ç' : 'Wystawi≈Ç/Wyda≈Ç';
    },

    addOperation() {
        const date = document.getElementById('opDate').value;
        const type = document.getElementById('opType').value;
        const vehicle = document.getElementById('opVehicle').value;
        const number = document.getElementById('opNumber').value;
        const contractor = document.getElementById('opContractor').value;
        const volume = parseFloat(document.getElementById('opVolume').value);
        const operator = document.getElementById('opOperator').value;

        if (!vehicle || !volume || !contractor || !operator) {
            alert('Wype≈Çnij wszystkie pola!');
            return;
        }

        this.operations.push({
            id: Date.now(),
            date, type, vehicle,
            number: parseInt(number),
            contractor, volume, operator
        });

        this.saveData();
        this.updateDisplay();
        
        document.getElementById('opContractor').value = '';
        document.getElementById('opVolume').value = '';
        document.getElementById('opOperator').value = '';
        this.updateNumber();
        
        alert('‚úÖ Operacja dodana!');
    },

    addVehicle() {
        const input = document.getElementById('newVehicle');
        const vehicle = input.value.trim().toUpperCase();
        if (!vehicle) return;
        if (this.vehicles.includes(vehicle)) {
            alert('Taki pojazd ju≈º istnieje!');
            return;
        }
        this.vehicles.push(vehicle);
        this.saveData();
        this.updateVehicleSelects();
        input.value = '';
        this.hideModal('addVehicle');
        alert('‚úÖ Pojazd dodany!');
    },

    deleteVehicle() {
        const vehicle = document.getElementById('vehicleToDelete').value;
        if (!vehicle) {
            alert('Wybierz pojazd!');
            return;
        }
        if (confirm(`UsunƒÖƒá pojazd ${vehicle}?`)) {
            this.vehicles = this.vehicles.filter(v => v !== vehicle);
            this.saveData();
            this.updateVehicleSelects();
            this.hideModal('deleteVehicle');
            alert('‚úÖ Pojazd usuniƒôty!');
        }
    },

    editOperation(id) {
        this.editingOp = this.operations.find(op => op.id === id);
        document.getElementById('editDate').value = this.editingOp.date;
        document.getElementById('editType').value = this.editingOp.type;
        document.getElementById('editVehicle').value = this.editingOp.vehicle;
        document.getElementById('editNumber').value = this.editingOp.number;
        document.getElementById('editContractor').value = this.editingOp.contractor;
        document.getElementById('editVolume').value = this.editingOp.volume;
        document.getElementById('editOperator').value = this.editingOp.operator;
        this.showModal('editOperation');
    },

    saveEdit() {
        if (!this.editingOp) return;
        this.editingOp.date = document.getElementById('editDate').value;
        this.editingOp.type = document.getElementById('editType').value;
        this.editingOp.vehicle = document.getElementById('editVehicle').value;
        this.editingOp.number = parseInt(document.getElementById('editNumber').value);
        this.editingOp.contractor = document.getElementById('editContractor').value;
        this.editingOp.volume = parseFloat(document.getElementById('editVolume').value);
        this.editingOp.operator = document.getElementById('editOperator').value;
        this.saveData();
        this.updateDisplay();
        this.hideModal('editOperation');
        alert('‚úÖ Zaktualizowano!');
    },

    deleteOperation(id) {
        if (confirm('UsunƒÖƒá operacjƒô?')) {
            this.operations = this.operations.filter(op => op.id !== id);
            this.saveData();
            this.updateDisplay();
            alert('‚úÖ Usuniƒôto!');
        }
    },

    calcVolume() {
        const l = parseFloat(document.getElementById('calcLength').value);
        const w = parseFloat(document.getElementById('calcWidth').value);
        const h = parseFloat(document.getElementById('calcHeight').value);
        if (l && w && h) {
            const vol = (l * w * h).toFixed(2);
            document.getElementById('calcResultValue').textContent = vol + ' mp';
            document.getElementById('calcResult').style.display = 'block';
        } else {
            document.getElementById('calcResult').style.display = 'none';
        }
    },

    applyCalc() {
        const l = parseFloat(document.getElementById('calcLength').value);
        const w = parseFloat(document.getElementById('calcWidth').value);
        const h = parseFloat(document.getElementById('calcHeight').value);
        const v = document.getElementById('calcVehicle').value;
        if (l && w && h && v) {
            document.getElementById('opVolume').value = (l * w * h).toFixed(2);
            document.getElementById('opVehicle').value = v;
            this.hideModal('calculator');
            document.getElementById('calcLength').value = '';
            document.getElementById('calcWidth').value = '';
            document.getElementById('calcHeight').value = '';
        } else {
            alert('Wype≈Çnij wszystkie pola!');
        }
    },

    exportToCSV() {
        let csv = 'Data,Typ,Pojazd,Nr,Dostawca/Odbiorca,Objƒôto≈õƒá,PrzyjƒÖ≈Ç/Wystawi≈Ç\n';
        this.operations.forEach(op => {
            const date = new Date(op.date).toLocaleDateString('pl-PL');
            csv += `${date},${op.type},${op.vehicle},${op.number},${op.contractor},${op.volume},${op.operator}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Magazyn_Pyskowice_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        alert('üìÑ Wyeksportowano!');
    },

    backupData() {
        const backup = {
            operations: this.operations,
            vehicles: this.vehicles,
            timestamp: new Date().toISOString()
        };
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Backup_Pyskowice_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        alert('üíæ Backup utworzony!');
    },

    restoreData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const backup = JSON.parse(e.target.result);
                if (confirm('Przywr√≥ciƒá dane?')) {
                    this.operations = backup.operations || [];
                    this.vehicles = backup.vehicles || [];
                    this.saveData();
                    this.updateVehicleSelects();
                    this.updateDisplay();
                    alert('‚úÖ Przywr√≥cono!');
                }
            } catch (err) {
                alert('‚ùå B≈ÇƒÖd pliku!');
            }
        };
        reader.readAsText(file);
    },

    togglePeriod() {
        const period = document.getElementById('reportPeriod').value;
        document.getElementById('monthField').style.display = period === 'monthly' ? 'block' : 'none';
        document.getElementById('yearField').style.display = period === 'yearly' ? 'block' : 'none';
    },

    generateReport() {
        const period = document.getElementById('reportPeriod').value;
        const type = document.getElementById('reportType').value;
        const month = document.getElementById('reportMonth').value;
        const year = document.getElementById('reportYear').value;

        let filtered = this.operations;
        if (period === 'monthly') {
            filtered = filtered.filter(op => op.date.startsWith(month));
        } else {
            filtered = filtered.filter(op => op.date.startsWith(year));
        }
        if (type !== 'complete') {
            filtered = filtered.filter(op => op.type === type);
        }

        const stats = {
            totalPZ: 0, totalWZ: 0, balance: 0,
            operations: filtered.length,
            byVehicle: {}
        };

        filtered.forEach(op => {
            const vol = parseFloat(op.volume);
            if (op.type === 'PZ') {
                stats.totalPZ += vol;
                stats.balance += vol;
            } else {
                stats.totalWZ += vol;
                stats.balance -= vol;
            }
            if (!stats.byVehicle[op.vehicle]) {
                stats.byVehicle[op.vehicle] = { PZ: 0, WZ: 0, count: 0 };
            }
            stats.byVehicle[op.vehicle][op.type] += vol;
            stats.byVehicle[op.vehicle].count++;
        });

        const periodText = period === 'monthly' 
            ? new Date(month + '-01').toLocaleDateString('pl-PL', { year: 'numeric', month: 'long' })
            : year;
        const typeText = type === 'complete' ? 'Kompletny' : type;

        document.getElementById('reportTitle').textContent = 
            `Raport ${period === 'monthly' ? 'Miesiƒôczny' : 'Roczny'} - ${typeText}`;

        let html = `<div style="margin-bottom:16px;font-weight:600;">Okres: ${periodText}</div>`;
        html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-bottom:24px;">';
        
        html += `<div style="background:#dbeafe;padding:16px;border-radius:8px;border:2px solid #3b82f6;">
            <div style="font-size:14px;font-weight:600;">Liczba operacji</div>
            <div style="font-size:24px;font-weight:bold;">${stats.operations}</div>
        </div>`;
        
        if (type === 'complete' || type === 'PZ') {
            html += `<div style="background:#d1fae5;padding:16px;border-radius:8px;border:2px solid #10b981;">
                <div style="font-size:14px;font-weight:600;">Suma PZ</div>
                <div style="font-size:24px;font-weight:bold;">${stats.totalPZ.toFixed(2)} mp</div>
            </div>`;
        }
        
        if (type === 'complete' || type === 'WZ') {
            html += `<div style="background:#fed7aa;padding:16px;border-radius:8px;border:2px solid #f97316;">
                <div style="font-size:14px;font-weight:600;">Suma WZ</div>
                <div style="font-size:24px;font-weight:bold;">${stats.totalWZ.toFixed(2)} mp</div>
            </div>`;
        }
        
        if (type === 'complete') {
            html += `<div style="background:#e9d5ff;padding:16px;border-radius:8px;border:2px solid #a78bfa;">
                <div style="font-size:14px;font-weight:600;">Bilans</div>
                <div style="font-size:24px;font-weight:bold;">${stats.balance.toFixed(2)} mp</div>
            </div>`;
        }
        html += '</div>';

        html += '<h3 style="margin:24px 0 16px;font-weight:600;">Zestawienie wed≈Çug pojazd√≥w</h3>';
        html += '<table style="width:100%;border-collapse:collapse;margin-bottom:24px;"><thead><tr style="background:#f3f4f6;">';
        html += '<th style="padding:12px;border:2px solid #e5e7eb;">Pojazd</th>';
        html += '<th style="padding:12px;text-align:right;border:2px solid #e5e7eb;">Operacje</th>';
        if (type === 'complete' || type === 'PZ') {
            html += '<th style="padding:12px;text-align:right;border:2px solid #e5e7eb;">PZ (mp)</th>';
        }
        if (type === 'complete' || type === 'WZ') {
            html += '<th style="padding:12px;text-align:right;border:2px solid #e5e7eb;">WZ (mp)</th>';
        }
        html += '</tr></thead><tbody>';

        Object.entries(stats.byVehicle).forEach(([vehicle, data]) => {
            html += '<tr>';
            html += `<td style="padding:12px;border:2px solid #e5e7eb;font-weight:600;">${vehicle}</td>`;
            html += `<td style="padding:12px;text-align:right;border:2px solid #e5e7eb;">${data.count}</td>`;
            if (type === 'complete' || type === 'PZ') {
                html += `<td style="padding:12px;text-align:right;border:2px solid #e5e7eb;color:#10b981;font-weight:600;">${data.PZ.toFixed(2)}</td>`;
            }
            if (type === 'complete' || type === 'WZ') {
                html += `<td style="padding:12px;text-align:right;border:2px solid #e5e7eb;color:#f97316;font-weight:600;">${data.WZ.toFixed(2)}</td>`;
            }
            html += '</tr>';
        });
        html += '</tbody></table>';

        html += '<h3 style="margin:24px 0 16px;font-weight:600;">Szczeg√≥≈Çowa lista operacji</h3>';
        html += '<div style="max-height:400px;overflow-y:auto;"><table style="width:100%;border-collapse:collapse;">';
        html += '<thead style="position:sticky;top:0;background:white;"><tr style="background:#f3f4f6;">';
        html += '<th style="padding:12px;border:2px solid #e5e7eb;">Data</th>';
        html += '<th style="padding:12px;border:2px solid #e5e7eb;">Typ</th>';
        html += '<th style="padding:12px;border:2px solid #e5e7eb;">Pojazd</th>';
        html += '<th style="padding:12px;text-align:right;border:2px solid #e5e7eb;">Nr</th>';
        html += '<th style="padding:12px;border:2px solid #e5e7eb;">Dostawca/Odbiorca</th>';
        html += '<th style="padding:12px;text-align:right;border:2px solid #e5e7eb;">Objƒôto≈õƒá</th>';
        html += '<th style="padding:12px;border:2px solid #e5e7eb;">PrzyjƒÖ≈Ç/Wystawi≈Ç</th>';
        html += '</tr></thead><tbody>';

        filtered.forEach(op => {
            const date = new Date(op.date).toLocaleDateString('pl-PL');
            html += '<tr>';
            html += `<td style="padding:12px;border:2px solid #e5e7eb;">${date}</td>`;
            html += `<td style="padding:12px;border:2px solid #e5e7eb;"><span class="badge badge-${op.type.toLowerCase()}">${op.type}</span></td>`;
            html += `<td style="padding:12px;border:2px solid #e5e7eb;font-weight:600;">${op.vehicle}</td>`;
            html += `<td style="padding:12px;text-align:right;border:2px solid #e5e7eb;">${op.number}</td>`;
            html += `<td style="padding:12px;border:2px solid #e5e7eb;">${op.contractor || '-'}</td>`;
            html += `<td style="padding:12px;text-align:right;border:2px solid #e5e7eb;font-weight:600;">${op.volume.toFixed(2)}</td>`;
            html += `<td style="padding:12px;border:2px solid #e5e7eb;">${op.operator || '-'}</td>`;
            html += '</tr>';
        });
        html += '</tbody></table></div>';

        document.getElementById('reportContent').innerHTML = html;
        this.hideModal('report');
        this.showModal('viewReport');
    },

    updateDisplay() {
        // Statystyki
        let currentStock = 0;
        let monthlyPZ = 0;
        let monthlyWZ = 0;
        const currentMonth = new Date().toISOString().slice(0, 7);

        this.operations.forEach(op => {
            currentStock += op.type === 'PZ' ? op.volume : -op.volume;
            if (op.date.startsWith(currentMonth)) {
                if (op.type === 'PZ') monthlyPZ += op.volume;
                else monthlyWZ += op.volume;
            }
        });

        document.getElementById('currentStock').textContent = currentStock.toFixed(2);
        document.getElementById('monthlyPZ').textContent = monthlyPZ.toFixed(2);
        document.getElementById('monthlyWZ').textContent = monthlyWZ.toFixed(2);

        // Raport na pojazd
        const vehicleStats = {};
        this.operations.forEach(op => {
            if (!vehicleStats[op.vehicle]) {
                vehicleStats[op.vehicle] = { PZ: 0, WZ: 0 };
            }
            vehicleStats[op.vehicle][op.type] += op.volume;
        });

        let vhtml = '';
        Object.entries(vehicleStats).forEach(([vehicle, stats]) => {
            vhtml += `<tr>
                <td style="font-weight:600;">${vehicle}</td>
                <td style="text-align:right;color:#10b981;font-weight:600;">${stats.PZ.toFixed(2)}</td>
                <td style="text-align:right;color:#f97316;font-weight:600;">${stats.WZ.toFixed(2)}</td>
            </tr>`;
        });
        document.getElementById('vehicleReportBody').innerHTML = vhtml;

        // Historia
        let ohtml = '';
        [...this.operations].reverse().forEach(op => {
            const date = new Date(op.date).toLocaleDateString('pl-PL');
            ohtml += `<tr>
                <td>${date}</td>
                <td><span class="badge badge-${op.type.toLowerCase()}">${op.type}</span></td>
                <td style="font-weight:600;">${op.vehicle}</td>
                <td style="text-align:right;">${op.number}</td>
                <td>${op.contractor || '-'}</td>
                <td style="text-align:right;font-weight:600;">${op.volume.toFixed(2)}</td>
                <td>${op.operator || '-'}</td>
                <td style="text-align:center;">
                    <button class="icon-btn" onclick="app.editOperation(${op.id})" title="Edytuj">‚úèÔ∏è</button>
                    <button class="icon-btn" onclick="app.deleteOperation(${op.id})" title="Usu≈Ñ">üóëÔ∏è</button>
                </td>
            </tr>`;
        });
        document.getElementById('operationsTableBody').innerHTML = ohtml;
    },

    showModal(name) {
        document.getElementById(name + 'Moda